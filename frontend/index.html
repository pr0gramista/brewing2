<!DOCTYPE html>
<html>
  <head>
    <title>Temperature meter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        font-family: 'Roboto Condensed', sans-serif;
      }

      #chart {
        width: 100%;
        height: 100vh;
      }

      #last_temp {
        position: fixed;
        top: 10px;
        left: 10px;
        font-size: 32px;
      }
    </style>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed&display=swap" rel="stylesheet">
  </head>
  <body>
    <div>
      <div>
        <div id="last_temp"></div>
        <input id="chart_size" type="number" />
        <input id="pass" />
        <button id="pass_button">Save password</button>
        <button id="refresh">Refresh</button>
      </div>
      <div>
        <canvas id="chart"></canvas>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js" integrity="sha256-xKeoJ50pzbUGkpQxDYHD7o7hxe0LaOGeguUidbq6vis=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js" integrity="sha256-S1J4GVHHDMiirir9qsXWc8ZWw74PHHafpsHp5PXtjTs=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js" integrity="sha256-oE03O+I6Pzff4fiMqwEGHbdfcW7a3GRRxlL+U49L5sA=" crossorigin="anonymous"></script>
    <script>
      let graphDataSize = 500;
      let chart;

      // Set up password
      document.getElementById("pass_button").onclick = (e) => {
        const pass = document.getElementById("pass").value;
        Cookies.set("brewing2", pass, { expires: 365 });
        document.cookie = pass;
      }

      // Set up chart size input
      const chartSizeInput = document.getElementById("chart_size");
      chartSizeInput.value = graphDataSize;
      chartSizeInput.onchange = (e) => {
        graphDataSize = e.target.value;
        console.log('Setting graph data size to ' + e.target.value);
      }

      function graph() {
        axios.get('https://europe-west1-brewing2.cloudfunctions.net/getter', {
          headers: {
            'Authorization': Cookies.get("brewing2")
          }
        })
        .then(response => {
          let data = response.data;
          data = data.reverse().slice(Math.max(data.length - graphDataSize, 0));

          // Set temp display
          const lastEntry = data[data.length - 1];
          document.getElementById("last_temp").innerText = lastEntry.temp + " C";

          const ctx = document.getElementById('chart').getContext('2d');

          if (chart === undefined) {
            chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: data.map(t => t.timestamp).map(t => new Date(t).toLocaleString()),
                datasets: [{
                  label: 'Temperature',
                  backgroundColor: 'rgba(231,76,60, 0.5)',
                  borderColor: 'rgb(231,76,60)',
                  data: data.map(t => t.temp)
                },
                {
                  label: 'CPU Temperature',
                  backgroundColor: 'rgba(44,62,80, 0.2)',
                  borderColor: 'rgb(44,62,80)',
                  data: data.map(t => t.cpu_temp)
                }],
              }
            });
          } else {
            chart.data.datasets.forEach((dataset) => {
              if (dataset.label === 'Temperature') {
                dataset.labels = data.map(t => t.timestamp).map(t => new Date(t).toLocaleString());
                dataset.data = data.map(t => t.temp);
              } else if (dataset.label === 'CPU Temperature') {
                dataset.labels = data.map(t => t.timestamp).map(t => new Date(t).toLocaleString());
                dataset.data = data.map(t => t.cpu_temp);
              }
            });
          }
        });
      };

      document.getElementById("refresh").onclick = graph;

      window.onload = () => {
        graph()
        setInterval(graph, 180000)
      }
    </script>
  </body>
</html>